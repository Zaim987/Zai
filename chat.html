<!DOCTYPE html><html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Chat</title>
  <style>
    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
    }body {
  background-color: #0e0e16;
  color: white;
  font-family: 'Segoe UI', sans-serif;
  height: 100dvh;
  overflow: hidden;
  display: flex;
  flex-direction: column;
}

#chat-header {
  background-color: #111;
  padding: 0.75rem 1rem;
  display: flex;
  align-items: center;
  position: fixed;
  top: 0;
  left: 0;
  right: 0;
  z-index: 10;
  border-bottom: 1px solid #222;
}

#chat-header img {
  width: 32px;
  height: 32px;
  border-radius: 50%;
  margin-right: 0.75rem;
}

#chat-header .back-button {
  margin-right: 0.75rem;
  font-size: 1.2rem;
  cursor: pointer;
}

#chat-body {
  flex: 1;
  margin-top: 60px;
  margin-bottom: 64px;
  overflow-y: auto;
  padding: 0.75rem 1rem;
  display: flex;
  flex-direction: column;
  gap: 0.5rem;
}

.bubble {
  max-width: 70%;
  padding: 0.5rem 0.75rem;
  border-radius: 1rem;
  font-size: 0.95rem;
  line-height: 1.4;
  word-wrap: break-word;
}

.from-me {
  align-self: flex-end;
  background-color: #007bff;
  color: white;
  border-bottom-right-radius: 0;
}

.from-other {
  align-self: flex-start;
  background-color: #222;
  color: white;
  border-bottom-left-radius: 0;
}

#chat-footer {
  position: fixed;
  bottom: 0;
  left: 0;
  right: 0;
  background-color: #111;
  padding: 0.5rem 0.75rem;
  display: flex;
  align-items: center;
  gap: 0.5rem;
  border-top: 1px solid #222;
}

#message-input {
  flex: 1;
  padding: 0.5rem 0.75rem;
  border-radius: 999px;
  border: none;
  outline: none;
  font-size: 1rem;
}

#send-button {
  background-color: #00aaff;
  color: white;
  border: none;
  padding: 0.5rem 1rem;
  border-radius: 999px;
  font-size: 1rem;
  cursor: pointer;
}

  </style>
</head>
<body>
  <div id="chat-header">
    <div class="back-button" onclick="window.history.back()">‚Üê</div>
    <img id="receiver-avatar" src="" alt="avatar" />
    <div>
      <div id="receiver-name">Nama</div>
      <div id="receiver-status" style="font-size: 0.8rem; color: lime">Online</div>
    </div>
  </div>  <div id="chat-body"></div>  <div id="chat-footer">
    <input type="text" id="message-input" placeholder="Ketik pesan..." />
    <button id="send-button">Kirim</button>
  </div>  <script type="module">
    import {
      getAuth,
      onAuthStateChanged,
      signOut
    } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-auth.js";
    import {
      getFirestore,
      doc,
      getDoc,
      updateDoc,
      addDoc,
      collection,
      onSnapshot,
      serverTimestamp,
      query,
      orderBy
    } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-firestore.js";
    import { app } from "./js";

    const auth = getAuth(app);
    const db = getFirestore(app);

    let currentUser;
    let otherUserId;
    let chatId;

    onAuthStateChanged(auth, async (user) => {
      if (!user) return location.href = 'login.html';
      currentUser = user;
      updateOnlineStatus(true);

      window.addEventListener("beforeunload", () => {
        updateOnlineStatus(false);
      });

      otherUserId = new URLSearchParams(location.search).get("uid");
      chatId = [user.uid, otherUserId].sort().join("_");

      const otherUserDoc = await getDoc(doc(db, "users", otherUserId));
      if (otherUserDoc.exists()) {
        const data = otherUserDoc.data();
        document.getElementById("receiver-name").textContent = data.displayName;
        document.getElementById("receiver-avatar").src = `https://api.dicebear.com/6.x/adventurer/svg?seed=${data.displayName}`;
        document.getElementById("receiver-status").textContent = data.online ? "Online" : "Offline";
        document.getElementById("receiver-status").style.color = data.online ? "lime" : "gray";
      }

      const chatRef = collection(db, "chats", chatId, "messages");
      const q = query(chatRef, orderBy("timestamp"));
      onSnapshot(q, (snapshot) => {
        const chatBody = document.getElementById("chat-body");
        chatBody.innerHTML = "";
        snapshot.forEach((doc) => {
          const msg = doc.data();
          const div = document.createElement("div");
          div.className = "bubble " + (msg.sender === user.uid ? "from-me" : "from-other");
          div.textContent = msg.text;
          chatBody.appendChild(div);
        });
        chatBody.scrollTop = chatBody.scrollHeight;
      });
    });

    document.getElementById("send-button").onclick = sendMessage;
    document.getElementById("message-input").addEventListener("keypress", e => {
      if (e.key === "Enter") sendMessage();
    });

    async function sendMessage() {
      const input = document.getElementById("message-input");
      const text = input.value.trim();
      if (!text) return;
      input.value = "";
      await addDoc(collection(db, "chats", chatId, "messages"), {
        sender: currentUser.uid,
        text,
        timestamp: serverTimestamp()
      });
    }

    function updateOnlineStatus(state) {
      if (currentUser?.uid) {
        updateDoc(doc(db, "users", currentUser.uid), {
          online: state,
          lastActive: serverTimestamp()
        });
      }
    }

    // Auto-scroll when keyboard resizes viewport
    window.addEventListener("resize", () => {
      const chatBody = document.getElementById("chat-body");
      chatBody.scrollTop = chatBody.scrollHeight;
    });
  </script></body>
</html>