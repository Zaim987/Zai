<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Sosial App</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&family=VT323&display=swap" rel="stylesheet">
    <style>
        /* Menggunakan font Inter sebagai default dan VT323 untuk tema hacker */
        :root {
            font-family: 'Inter', sans-serif;
        }

        /* Definisi variabel warna untuk setiap tema */
        [data-theme="light"] {
            --bg-primary: #ffffff;
            --bg-secondary: #f3f4f6;
            --bg-header-footer: #ffffff;
            --text-primary: #111827;
            --text-secondary: #6b7280;
            --accent-primary: #3b82f6;
            --accent-secondary: #1d4ed8;
            --border-color: #e5e7eb;
            --font-family: 'Inter', sans-serif;
        }

        [data-theme="dark"] {
            --bg-primary: #121212;
            --bg-secondary: #1f1f1f;
            --bg-header-footer: #1e1e1e;
            --text-primary: #e5e7eb;
            --text-secondary: #9ca3af;
            --accent-primary: #60a5fa;
            --accent-secondary: #3b82f6;
            --border-color: #374151;
            --font-family: 'Inter', sans-serif;
        }

        [data-theme="hacker"] {
            --bg-primary: #000000;
            --bg-secondary: #0a0a0a;
            --bg-header-footer: #050505;
            --text-primary: #00ff00;
            --text-secondary: #00dd00;
            --accent-primary: #00ff00;
            --accent-secondary: #00aa00;
            --border-color: #00ff00;
            --font-family: 'VT323', monospace;
        }

        /* Menerapkan variabel warna ke elemen */
        body {
            background-color: var(--bg-primary);
            color: var(--text-primary);
            font-family: var(--font-family);
            transition: background-color 0.3s, color 0.3s;
        }

        /* Layout utama aplikasi */
        #root {
            display: flex;
            flex-direction: column;
            height: 100vh;
            max-width: 600px; /* Lebar maksimal untuk tampilan seperti mobile */
            margin: 0 auto;
            border-left: 1px solid var(--border-color);
            border-right: 1px solid var(--border-color);
        }

        /* Header dan Footer statis */
        .app-header, .app-footer {
            flex-shrink: 0;
            background-color: var(--bg-header-footer);
            border-bottom: 1px solid var(--border-color);
            z-index: 10;
        }
        .app-footer {
            border-top: 1px solid var(--border-color);
            border-bottom: none;
        }

        /* Konten tengah yang bisa di-scroll */
        .app-content {
            flex-grow: 1;
            overflow-y: auto;
            background-color: var(--bg-secondary);
        }
        /* Kustomisasi scrollbar */
        .app-content::-webkit-scrollbar {
            width: 6px;
        }
        .app-content::-webkit-scrollbar-track {
            background: var(--bg-secondary);
        }
        .app-content::-webkit-scrollbar-thumb {
            background-color: var(--accent-primary);
            border-radius: 20px;
        }
    </style>
</head>
<body>
    <div id="root"></div>

    <script type="importmap">
        {
            "imports": {
                "react": "https://esm.sh/react@18.2.0",
                "react-dom/client": "https://esm.sh/react-dom@18.2.0/client",
                "firebase/app": "https://www.gstatic.com/firebasejs/10.12.2/firebase-app.js",
                "firebase/auth": "https://www.gstatic.com/firebasejs/10.12.2/firebase-auth.js",
                "firebase/firestore": "https://www.gstatic.com/firebasejs/10.12.2/firebase-firestore.js"
            }
        }
    </script>

    <script type="module">
        import React, { useState, useEffect, useRef, useMemo } from 'react';
        import { createRoot } from 'react-dom/client';
        import { initializeApp } from 'firebase/app';
        import { 
            getAuth, 
            createUserWithEmailAndPassword, 
            signInWithEmailAndPassword, 
            signOut, 
            onAuthStateChanged 
        } from 'firebase/auth';
        import { 
            getFirestore, 
            collection, 
            addDoc, 
            query, 
            orderBy, 
            onSnapshot, 
            serverTimestamp,
            doc,
            setDoc,
            getDocs
        } from 'firebase/firestore';

        // Konfigurasi Firebase yang Anda berikan
        const firebaseConfig = {
            apiKey: "AIzaSyApM08t1ghCxK56_0znbPMT9i5zduOKmn0",
            authDomain: "quantechapp.firebaseapp.com",
            projectId: "quantechapp",
            storageBucket: "quantechapp.appspot.com",
            messagingSenderId: "825384610343",
            appId: "1:825384610343:web:e490bc84877e6d7a93bc02"
        };

        // Inisialisasi Firebase
        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const db = getFirestore(app);

        // Komponen Ikon sederhana
        const Icon = ({ path, className = "w-6 h-6" }) => (
            <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" strokeWidth={1.5} stroke="currentColor" className={className}>
                <path strokeLinecap="round" strokeLinejoin="round" d={path} />
            </svg>
        );

        // Komponen untuk Halaman Autentikasi (Login & Register)
        const AuthPage = () => {
            const [isLogin, setIsLogin] = useState(true);
            const [email, setEmail] = useState('');
            const [password, setPassword] = useState('');
            const [username, setUsername] = useState('');
            const [error, setError] = useState('');
            const [loading, setLoading] = useState(false);

            const handleAuthAction = async (e) => {
                e.preventDefault();
                setLoading(true);
                setError('');
                try {
                    if (isLogin) {
                        await signInWithEmailAndPassword(auth, email, password);
                    } else {
                        if (!username) {
                            setError("Username tidak boleh kosong.");
                            setLoading(false);
                            return;
                        }
                        const userCredential = await createUserWithEmailAndPassword(auth, email, password);
                        // Simpan data user ke Firestore
                        await setDoc(doc(db, "users", userCredential.user.uid), {
                            username: username,
                            email: email,
                            uid: userCredential.user.uid
                        });
                    }
                } catch (err) {
                    setError(err.message);
                } finally {
                    setLoading(false);
                }
            };

            return (
                <div className="h-screen flex flex-col justify-center items-center p-4" style={{ backgroundColor: 'var(--bg-primary)' }}>
                    <h1 className="text-4xl font-bold mb-8" style={{ color: 'var(--accent-primary)' }}>Sosial App</h1>
                    <div className="w-full max-w-sm p-6 rounded-lg shadow-md" style={{ backgroundColor: 'var(--bg-secondary)' }}>
                        <h2 className="text-2xl font-bold text-center mb-4" style={{ color: 'var(--text-primary)' }}>{isLogin ? 'Login' : 'Daftar'}</h2>
                        <form onSubmit={handleAuthAction}>
                            {!isLogin && (
                                <div className="mb-4">
                                    <label className="block text-sm font-bold mb-2" style={{ color: 'var(--text-secondary)' }}>Username</label>
                                    <input type="text" value={username} onChange={(e) => setUsername(e.target.value)} className="w-full px-3 py-2 rounded" style={{ backgroundColor: 'var(--bg-primary)', color: 'var(--text-primary)', border: '1px solid var(--border-color)' }} placeholder="Username Anda" />
                                </div>
                            )}
                            <div className="mb-4">
                                <label className="block text-sm font-bold mb-2" style={{ color: 'var(--text-secondary)' }}>Email</label>
                                <input type="email" value={email} onChange={(e) => setEmail(e.target.value)} className="w-full px-3 py-2 rounded" style={{ backgroundColor: 'var(--bg-primary)', color: 'var(--text-primary)', border: '1px solid var(--border-color)' }} placeholder="email@contoh.com" />
                            </div>
                            <div className="mb-6">
                                <label className="block text-sm font-bold mb-2" style={{ color: 'var(--text-secondary)' }}>Password</label>
                                <input type="password" value={password} onChange={(e) => setPassword(e.target.value)} className="w-full px-3 py-2 rounded" style={{ backgroundColor: 'var(--bg-primary)', color: 'var(--text-primary)', border: '1px solid var(--border-color)' }} placeholder="********" />
                            </div>
                            {error && <p className="text-red-500 text-xs italic mb-4">{error}</p>}
                            <button type="submit" disabled={loading} className="w-full font-bold py-2 px-4 rounded focus:outline-none focus:shadow-outline" style={{ backgroundColor: 'var(--accent-primary)', color: '#fff' }}>
                                {loading ? 'Memproses...' : (isLogin ? 'Login' : 'Daftar')}
                            </button>
                        </form>
                        <p className="text-center text-sm mt-4" style={{ color: 'var(--text-secondary)' }}>
                            {isLogin ? "Belum punya akun?" : "Sudah punya akun?"}
                            <button onClick={() => setIsLogin(!isLogin)} className="font-bold ml-1" style={{ color: 'var(--accent-primary)' }}>
                                {isLogin ? 'Daftar' : 'Login'}
                            </button>
                        </p>
                    </div>
                </div>
            );
        };

        // Komponen untuk Feed Status
        const Feed = ({ currentUser }) => {
            const [statuses, setStatuses] = useState([]);
            const [newStatus, setNewStatus] = useState('');
            const [users, setUsers] = useState({});

            useEffect(() => {
                // Ambil data semua user untuk menampilkan username
                const fetchUsers = async () => {
                    const usersCollection = collection(db, 'users');
                    const userSnapshot = await getDocs(usersCollection);
                    const userList = {};
                    userSnapshot.forEach(doc => {
                        userList[doc.id] = doc.data();
                    });
                    setUsers(userList);
                };
                fetchUsers();

                // Dapatkan status secara real-time
                const q = query(collection(db, "statuses"), orderBy("timestamp", "desc"));
                const unsubscribe = onSnapshot(q, (querySnapshot) => {
                    const statusesData = [];
                    querySnapshot.forEach((doc) => {
                        statusesData.push({ id: doc.id, ...doc.data() });
                    });
                    setStatuses(statusesData);
                });

                return () => unsubscribe();
            }, []);

            const handlePostStatus = async (e) => {
                e.preventDefault();
                if (newStatus.trim() === '') return;

                await addDoc(collection(db, "statuses"), {
                    text: newStatus,
                    timestamp: serverTimestamp(),
                    uid: currentUser.uid,
                });
                setNewStatus('');
            };
            
            const formatTime = (timestamp) => {
                if (!timestamp) return 'beberapa saat lalu';
                return new Date(timestamp.seconds * 1000).toLocaleString('id-ID');
            }

            return (
                <div className="p-4">
                    <form onSubmit={handlePostStatus} className="mb-4">
                        <textarea
                            value={newStatus}
                            onChange={(e) => setNewStatus(e.target.value)}
                            placeholder="Apa yang kamu pikirkan?"
                            className="w-full p-2 rounded-lg"
                            style={{ backgroundColor: 'var(--bg-primary)', color: 'var(--text-primary)', border: '1px solid var(--border-color)' }}
                        ></textarea>
                        <button type="submit" className="w-full mt-2 font-bold py-2 px-4 rounded" style={{ backgroundColor: 'var(--accent-primary)', color: '#fff' }}>
                            Posting
                        </button>
                    </form>
                    <div>
                        {statuses.map(status => (
                            <div key={status.id} className="p-4 mb-3 rounded-lg" style={{ backgroundColor: 'var(--bg-primary)', border: '1px solid var(--border-color)' }}>
                                <div className="flex items-center mb-2">
                                    <div className="font-bold" style={{ color: 'var(--text-primary)' }}>
                                        {users[status.uid]?.username || 'User Anonim'}
                                    </div>
                                    <div className="text-xs ml-auto" style={{ color: 'var(--text-secondary)' }}>
                                        {formatTime(status.timestamp)}
                                    </div>
                                </div>
                                <p style={{ color: 'var(--text-primary)' }}>{status.text}</p>
                            </div>
                        ))}
                    </div>
                </div>
            );
        };
        
        // Komponen untuk menampilkan daftar user untuk DM
        const UsersList = ({ setCurrentPage, setRecipient }) => {
            const [users, setUsers] = useState([]);
            const [loading, setLoading] = useState(true);

            useEffect(() => {
                const fetchUsers = async () => {
                    const usersCollection = collection(db, 'users');
                    const userSnapshot = await getDocs(usersCollection);
                    const usersList = userSnapshot.docs
                        .map(doc => ({ id: doc.id, ...doc.data() }))
                        .filter(user => user.id !== auth.currentUser.uid); // Jangan tampilkan diri sendiri
                    setUsers(usersList);
                    setLoading(false);
                };

                fetchUsers();
            }, []);

            const startChat = (user) => {
                setRecipient(user);
                setCurrentPage('chat');
            };

            if (loading) return <div className="p-4 text-center" style={{ color: 'var(--text-secondary)' }}>Memuat daftar pengguna...</div>;
            
            return (
                <div className="p-2">
                    <h2 className="text-xl font-bold p-2" style={{ color: 'var(--text-primary)' }}>Mulai Percakapan</h2>
                    {users.map(user => (
                        <div 
                            key={user.id} 
                            onClick={() => startChat(user)}
                            className="flex items-center p-3 mb-2 rounded-lg cursor-pointer hover:opacity-75" 
                            style={{ backgroundColor: 'var(--bg-primary)' }}
                        >
                            <div className="w-10 h-10 rounded-full flex items-center justify-center mr-3" style={{ backgroundColor: 'var(--accent-primary)' }}>
                                <span className="text-white font-bold">{user.username.charAt(0).toUpperCase()}</span>
                            </div>
                            <div>
                                <p className="font-bold" style={{ color: 'var(--text-primary)' }}>{user.username}</p>
                                <p className="text-sm" style={{ color: 'var(--text-secondary)' }}>{user.email}</p>
                            </div>
                        </div>
                    ))}
                </div>
            );
        };
        
        // Komponen untuk Halaman Chat DM
        const Chat = ({ recipient, currentUser }) => {
            const [messages, setMessages] = useState([]);
            const [newMessage, setNewMessage] = useState('');
            const chatBoxRef = useRef(null);

            const chatRoomId = useMemo(() => {
                // Membuat ID chat room yang konsisten
                return [currentUser.uid, recipient.id].sort().join('_');
            }, [currentUser.uid, recipient.id]);

            useEffect(() => {
                const messagesRef = collection(db, 'messages', chatRoomId, 'chats');
                const q = query(messagesRef, orderBy('timestamp'));

                const unsubscribe = onSnapshot(q, (querySnapshot) => {
                    const msgs = [];
                    querySnapshot.forEach(doc => {
                        msgs.push({ id: doc.id, ...doc.data() });
                    });
                    setMessages(msgs);
                });

                return () => unsubscribe();
            }, [chatRoomId]);

            useEffect(() => {
                // Auto-scroll ke pesan terbaru
                if (chatBoxRef.current) {
                    chatBoxRef.current.scrollTop = chatBoxRef.current.scrollHeight;
                }
            }, [messages]);

            const handleSendMessage = async (e) => {
                e.preventDefault();
                if (newMessage.trim() === '') return;

                const messagesRef = collection(db, 'messages', chatRoomId, 'chats');
                await addDoc(messagesRef, {
                    text: newMessage,
                    senderUid: currentUser.uid,
                    timestamp: serverTimestamp()
                });
                setNewMessage('');
            };

            return (
                <div className="flex flex-col h-full">
                    <div ref={chatBoxRef} className="flex-grow p-4 overflow-y-auto">
                        {messages.map(msg => (
                            <div key={msg.id} className={`flex mb-3 ${msg.senderUid === currentUser.uid ? 'justify-end' : 'justify-start'}`}>
                                <div className={`max-w-xs md:max-w-md p-3 rounded-lg ${msg.senderUid === currentUser.uid ? 'rounded-br-none' : 'rounded-bl-none'}`}
                                    style={{ 
                                        backgroundColor: msg.senderUid === currentUser.uid ? 'var(--accent-primary)' : 'var(--bg-primary)',
                                        color: msg.senderUid === currentUser.uid ? '#fff' : 'var(--text-primary)'
                                    }}
                                >
                                    {msg.text}
                                </div>
                            </div>
                        ))}
                    </div>
                    <form onSubmit={handleSendMessage} className="flex p-2 border-t" style={{ borderColor: 'var(--border-color)', backgroundColor: 'var(--bg-header-footer)'}}>
                        <input
                            type="text"
                            value={newMessage}
                            onChange={(e) => setNewMessage(e.target.value)}
                            placeholder="Ketik pesan..."
                            className="flex-grow p-2 rounded-lg"
                            style={{ backgroundColor: 'var(--bg-primary)', color: 'var(--text-primary)', border: '1px solid var(--border-color)' }}
                        />
                        <button type="submit" className="ml-2 p-2 rounded-lg" style={{ backgroundColor: 'var(--accent-primary)', color: '#fff' }}>
                            <Icon path="M6 12L3.269 3.126A59.768 59.768 0 0121.485 12 59.77 59.77 0 013.27 20.876L5.999 12zm0 0h7.5" />
                        </button>
                    </form>
                </div>
            );
        };


        // Komponen Utama Aplikasi
        const App = () => {
            const [user, setUser] = useState(null);
            const [loading, setLoading] = useState(true);
            const [theme, setTheme] = useState(localStorage.getItem('app-theme') || 'dark');
            const [currentPage, setCurrentPage] = useState('feed'); // 'feed', 'users', 'chat'
            const [recipient, setRecipient] = useState(null); // Untuk DM

            useEffect(() => {
                const unsubscribe = onAuthStateChanged(auth, (currentUser) => {
                    setUser(currentUser);
                    setLoading(false);
                });
                return () => unsubscribe();
            }, []);

            useEffect(() => {
                document.body.setAttribute('data-theme', theme);
                localStorage.setItem('app-theme', theme);
            }, [theme]);

            const handleThemeChange = () => {
                const themes = ['light', 'dark', 'hacker'];
                const currentIndex = themes.indexOf(theme);
                const nextIndex = (currentIndex + 1) % themes.length;
                setTheme(themes[nextIndex]);
            };
            
            const handleLogout = async () => {
                await signOut(auth);
                setCurrentPage('feed');
            };

            const renderPage = () => {
                switch (currentPage) {
                    case 'feed':
                        return <Feed currentUser={user} />;
                    case 'users':
                        return <UsersList setCurrentPage={setCurrentPage} setRecipient={setRecipient} />;
                    case 'chat':
                        if (recipient) {
                           return <Chat recipient={recipient} currentUser={user} />;
                        }
                        // Jika tidak ada recipient, kembali ke daftar user
                        setCurrentPage('users'); 
                        return null;
                    default:
                        return <Feed currentUser={user} />;
                }
            };
            
            const getHeaderTitle = () => {
                switch (currentPage) {
                    case 'feed': return 'Feed';
                    case 'users': return 'Pesan Baru';
                    case 'chat': return recipient?.username || 'Chat';
                    default: return 'Sosial App';
                }
            }

            if (loading) {
                return <div className="h-screen flex justify-center items-center" style={{ backgroundColor: 'var(--bg-primary)', color: 'var(--text-primary)' }}>Memuat Aplikasi...</div>;
            }

            if (!user) {
                return <AuthPage />;
            }

            return (
                <>
                    <header className="app-header p-4 flex justify-between items-center">
                        {currentPage === 'chat' && (
                            <button onClick={() => setCurrentPage('users')} className="p-2 -ml-2">
                                <Icon path="M15.75 19.5L8.25 12l7.5-7.5" className="w-6 h-6" style={{ color: 'var(--text-primary)' }} />
                            </button>
                        )}
                        <h1 className="text-xl font-bold" style={{ color: 'var(--text-primary)' }}>{getHeaderTitle()}</h1>
                        <div className="flex items-center space-x-2">
                            <button onClick={handleThemeChange} className="p-2">
                                <Icon path="M12 3v2.25m6.364.386l-1.591 1.591M21 12h-2.25m-.386 6.364l-1.591-1.591M12 18.75V21m-4.773-4.227l-1.591 1.591M5.25 12H3m4.227-4.773L5.636 5.636M15.75 12a3.75 3.75 0 11-7.5 0 3.75 3.75 0 017.5 0z" className="w-6 h-6" style={{ color: 'var(--text-primary)' }} />
                            </button>
                            <button onClick={handleLogout} className="p-2">
                                <Icon path="M15.75 9V5.25A2.25 2.25 0 0013.5 3h-6a2.25 2.25 0 00-2.25 2.25v13.5A2.25 2.25 0 007.5 21h6a2.25 2.25 0 002.25-2.25V15m-3 0l3-3m0 0l-3-3m3 3H9" className="w-6 h-6" style={{ color: 'var(--text-primary)' }} />
                            </button>
                        </div>
                    </header>
                    <main className="app-content">
                        {renderPage()}
                    </main>
                    <footer className="app-footer p-2 flex justify-around items-center">
                        <button onClick={() => setCurrentPage('feed')} className={`p-2 rounded-lg ${currentPage === 'feed' ? 'opacity-100' : 'opacity-60'}`}>
                           <Icon path="M2.25 12l8.954-8.955c.44-.439 1.152-.439 1.591 0L21.75 12M4.5 9.75v10.125c0 .621.504 1.125 1.125 1.125H9.75v-4.875c0-.621.504-1.125 1.125-1.125h2.25c.621 0 1.125.504 1.125 1.125V21h4.125c.621 0 1.125-.504 1.125-1.125V9.75M8.25 21h7.5" className="w-7 h-7" style={{ color: 'var(--accent-primary)' }} />
                        </button>
                        <button onClick={() => setCurrentPage('users')} className={`p-2 rounded-lg ${currentPage === 'users' || currentPage === 'chat' ? 'opacity-100' : 'opacity-60'}`}>
                            <Icon path="M8.625 12a.375.375 0 11-.75 0 .375.375 0 01.75 0zm0 0H8.25m4.125 0a.375.375 0 11-.75 0 .375.375 0 01.75 0zm0 0H12m4.125 0a.375.375 0 11-.75 0 .375.375 0 01.75 0zm0 0h-.375M21 12c0 4.556-4.03 8.25-9 8.25a9.76 9.76 0 01-2.53-.375m-10.492 0c-.106.02a.315.315 0 01-.315-.315a2.5 2.5 0 01.315-2.492C3.693 6.08 7.978 3 12 3c4.022 0 8.307 3.08 9.474 6.685a2.5 2.5 0 01.315 2.492.315.315 0 01-.315.315c-.106-.02-.215-.032-.326-.04a9.753 9.753 0 01-2.17-1.37c-.359-.2-.695-.418-1.026-.653a3.532 3.532 0 00-2.296-.653H12c-.896 0-1.73.29-2.424.777-.694.486-1.293 1.06-1.782 1.732a9.753 9.753 0 01-2.17 1.37c-.11.009-.22.02-.326.04z" className="w-7 h-7" style={{ color: 'var(--accent-primary)' }} />
                        </button>
                    </footer>
                </>
            );
        };

        const container = document.getElementById('root');
        const root = createRoot(container);
        root.render(<App />);

    </script>
</body>
</html>

